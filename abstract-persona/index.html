<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>DS1</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="./assets/css/style.css" />
    <script async src="https://ga.jspm.io/npm:es-module-shims@1.10.0/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <section class="vh-100 py-0 py-md-5 text-light text-center position-relative">
        <div id="app" class="w-100 h-100 z-3" style="position:absolute;top:0;right:0;"></div>
    </section>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./assets/js/animation.js"></script>
    
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { AsciiEffect } from 'https://cdn.jsdelivr.net/npm/three@0.148.0/examples/jsm/effects/AsciiEffect.js';

        let camera, scene, renderer, effect, mixer, clock, controls;

        init();

        async function init() {
            const container = document.getElementById('app');
            clock = new THREE.Clock();

            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera(15, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 5, 10);
            scene.add(camera);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setClearAlpha(1);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);

            // ASCII effect
            effect = new AsciiEffect(renderer, ' !*"Â£$%^&*()_+}{@~?>:}', {
                invert: true,
                color: false,
                resolution: 0.15
            });
            effect.setSize(window.innerWidth, window.innerHeight);

            const el = effect.domElement;
            el.style.position = 'absolute';
            el.style.top = '0';
            el.style.left = '0';
            el.style.width = '100%';
            el.style.height = '100%';
            el.style.background = 'transparent';
            el.style.lineHeight = '6px';
            el.style.letterSpacing = '0px';
            el.style.pointerEvents = 'auto'; // IMPORTANT: allow controls to grab input
            el.style.touchAction = 'none';   // improve touch interaction
            container.appendChild(el);

            // OrbitControls enabled
            controls = new OrbitControls(camera, el);
            controls.target.set(0, 1.0, 0);
            controls.enableDamping = true;
            controls.dampingFactor = 0.08;
            controls.rotateSpeed = 0.9;
            controls.zoomSpeed = 1.0;
            controls.panSpeed = 0.8;
            controls.minDistance = 1.2;
            controls.maxDistance = 12;
            controls.maxPolarAngle = Math.PI * 0.495;

            // Load GLB + animation
            const gltf = await new GLTFLoader().loadAsync('../models/dancer.glb');
            const model = gltf.scene;

            model.traverse(o => {
            if (o.isMesh && o.material?.isMeshBasicMaterial) {
                o.material = new THREE.MeshStandardMaterial({
                map: o.material.map ?? null,
                color: new THREE.Color(Math.random(), Math.random(), Math.random())
                });
            }
            });

            const box = new THREE.Box3().setFromObject(model);
            model.position.y -= (box.min.y + 0.75);
            scene.add(model);

            mixer = new THREE.AnimationMixer(model);
            if (gltf.animations?.length) mixer.clipAction(gltf.animations[0]).play();

            window.addEventListener('resize', onWindowResize);
            renderer.setAnimationLoop(animate);
        }

        function onWindowResize() {
            const w = window.innerWidth, h = window.innerHeight;
            camera.aspect = w / h;
            camera.updateProjectionMatrix();
            renderer.setSize(w, h);
            effect.setSize(w, h);
        }

        function animate() {
            const dt = clock.getDelta();
            if (mixer) mixer.update(dt);
            controls.update();          // update controls each frame
            effect.render(scene, camera);
}
    </script>
</body>
</html>
